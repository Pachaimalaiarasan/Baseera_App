<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>My Orders</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <style>
        :root {
            --primary-color: #007BFF;
            --danger-color: #DC3545;
            --success-color: #28a745;
            --bg-color: #F8F9FA;
            --sidebar-bg: #FFFFFF;
            --text-dark: #212529;
            --text-light: #6C757D;
            --border-color: #DEE2E6;
            --sidebar-width: 260px;
            --shadow-soft: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        *, *::before, *::after { box-sizing: border-box; }
        body {
            margin: 0;
            background: var(--bg-color);
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            color: var(--text-dark);
        }
        .page-container { display: flex; }

        /* Sidebar, Header, etc. (Styles remain the same) */
        .sidebar{width:var(--sidebar-width);height:100vh;background:var(--sidebar-bg);position:fixed;top:0;left:0;border-right:1px solid var(--border-color);display:flex;flex-direction:column;padding:20px 0;z-index:1100;transition:transform .3s ease}.sidebar-header{padding:0 24px 20px 24px;font-size:24px;font-weight:700;color:var(--primary-color)}.nav-menu{list-style:none;padding:0;margin:0}.nav-btn{display:flex;align-items:center;gap:15px;color:var(--text-light);font-size:16px;font-weight:500;text-decoration:none;padding:14px 24px;transition:color .2s ease,background-color .2s ease;position:relative}.nav-btn .nav-icon{font-size:20px;width:24px;text-align:center}.nav-btn:hover{color:var(--primary-color)}.nav-btn.active{color:var(--primary-color);background-color:#F0F6FF}.nav-btn.active::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:4px;height:24px;background-color:var(--primary-color);border-radius:0 4px 4px 0}
        .content-wrapper{flex-grow:1;margin-left:var(--sidebar-width);display:flex;flex-direction:column;transition:margin-left .3s ease}.header-bar{background:var(--sidebar-bg);padding:16px 24px;border-bottom:1px solid var(--border-color);position:sticky;top:0;z-index:900}.header-bar h2{margin:0 0 16px 0;font-size:28px;font-weight:700;color:var(--text-dark);text-align:center}.controls-container{display:flex;gap:16px;align-items:center}.category-tabs{display:flex;gap:8px;overflow-x:auto;-ms-overflow-style:none;scrollbar-width:none}.category-tabs::-webkit-scrollbar{display:none}.category-tab{padding:8px 16px;border:none;background:0 0;color:var(--text-light);cursor:pointer;transition:color .3s,border-bottom .3s;font-weight:500;font-size:15px;border-bottom:3px solid transparent;white-space:nowrap}.category-tab.active{color:var(--primary-color);border-bottom-color:var(--primary-color)}.search-box{flex-shrink:0;width:300px;position:relative}.search-box .fa-search{position:absolute;left:16px;top:50%;transform:translateY(-50%);color:var(--text-light)}.search-box input{width:100%;padding:12px 16px 12px 40px;border-radius:8px;border:1px solid var(--border-color);font-size:15px;outline:0}main{padding:24px}

        /* --- Order Card Design --- */
        .orders-list { display: grid; grid-template-columns: 1fr; gap: 24px; }
        .order-card {
            background: #fff; border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-soft);
            display: flex; flex-direction: column;
        }
        .order-header {
            padding: 16px 20px; display: flex;
            justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border-color);
        }
        .order-title { font-size: 18px; font-weight: 600; }
        .order-status-badge { padding: 4px 12px; border-radius: 20px; font-weight: 500; font-size: 13px; }
        .order-status-pending{background:#fff0c2;color:#a17400}.order-status-accepted{background:#d4eaff;color:#0062a1}.order-status-completed{background:#d7f5de;color:#1f8b3a}.order-status-rejected,.order-status-cancelled{background:#ffe0e0;color:#c22525}

        /* NEW STYLES for image layout */
        .order-card-content {
            display: flex;
            gap: 20px;
            padding: 20px;
        }
        .order-card-image {
            width: 110px;
            flex-shrink: 0;
        }
        .order-card-image img {
            width: 100%;
            aspect-ratio: 1 / 1;
            object-fit: cover;
            border-radius: 8px;
            background-color: #f0f0f0;
        }
        .order-card-details {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        /* END NEW STYLES */

        .info-row { display: flex; align-items: center; gap: 12px; font-size: 15px; }
        .info-row i.fa-solid { width: 20px; text-align: center; color: var(--primary-color); }
        .info-row label { color: var(--text-light); }
        .info-row span { font-weight: 500; }
        .order-summary { background: var(--bg-color); padding: 16px; border-radius: 8px; }
        .total-row { display: flex; justify-content: space-between; font-weight: 600; font-size: 16px; }
        .payment-status { display: flex; justify-content: space-between; font-size: 14px; margin-top: 8px; }
        .order-actions { padding: 16px 0 0 0; }
        .btn {
            width: 100%; padding: 12px; border: none; border-radius: 8px;
            font-weight: 500; cursor: pointer; font-size: 15px;
            transition: background-color 0.3s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-cancel { background: var(--danger-color); color: #fff; }
        .btn-cancel:hover { background: #c82333; }
        
        /* --- Responsiveness --- */
        .bottom-nav { display: none; }

        @media (max-width: 1024px) {
            .sidebar { transform: translateX(-100%); }
            .content-wrapper { margin-left: 0; }
        }
        @media (max-width: 767px) {
            .sidebar { display: none; }
            main { padding: 16px; }
            .header-bar { padding: 16px; }
            .header-bar h2 { font-size: 22px; }
            .controls-container { flex-direction: column; gap: 12px; align-items: stretch; }
            .category-tabs { border-bottom: 1px solid var(--border-color); padding-bottom: 12px; }
            .search-box { width: 100%; }
            body { padding-bottom: 70px; }
            .bottom-nav {
                position: fixed; bottom: 0; left: 0; right: 0;
                height: 70px; background: var(--sidebar-bg);
                display: flex; justify-content: space-around; align-items: center;
                box-shadow: 0 -2px 10px rgba(0,0,0,0.08); z-index: 1000;
            }
            .bottom-nav .nav-btn { flex-direction: column; gap: 4px; font-size: 12px; padding: 8px 4px; }
            .nav-btn.active::before { display: none; }

            /* Card image layout for mobile */
            .order-card-content {
                flex-direction: column;
            }
            .order-card-image {
                width: 100%;
                height: 150px; /* Give a fixed height on mobile */
            }
        }
    </style>
</head>
<body>

    <div class="page-container">
        <nav class="sidebar">
            <div class="sidebar-header">My Account</div>
            <ul class="nav-menu">
                <li><a href="../customer_dashboard.html" class="nav-btn"><i class="fa-solid fa-home nav-icon"></i> Home</a></li>
                <li><a href="./customer_booking.html" class="nav-btn active"><i class="fa-solid fa-box-open nav-icon"></i> Orders</a></li>
                <li><a href="./customer_product.html" class="nav-btn"><i class="fa-solid fa-shopping-bag nav-icon"></i> Products</a></li>
                <li><a href="./customer_profile.html" class="nav-btn"><i class="fa-solid fa-user nav-icon"></i> Profile</a></li>
            </ul>
        </nav>

        <div class="content-wrapper">
            <div class="header-bar">
                <h2>My Orders</h2>
                <div class="controls-container">
                    <div class="category-tabs">
                        <button class="category-tab active" data-status="today">Today</button>
                        <button class="category-tab" data-status="upcoming">Upcoming</button>
                        <button class="category-tab" data-status="history">History</button>
                        <button class="category-tab" data-status="rejected">Rejected</button>
                    </div>
                    <div class="search-box">
                        <i class="fa-solid fa-search"></i>
                        <input type="text" id="searchInput" placeholder="Search by car or service...">
                    </div>
                </div>
            </div>
            <main>
                <div id="orders-list" class="orders-list"></div>
            </main>
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="../customer_dashboard.html" class="nav-btn"><i class="fa-solid fa-home nav-icon"></i><span>Home</span></a>
        <a href="./customer_booking.html" class="nav-btn active"><i class="fa-solid fa-box-open nav-icon"></i><span>Orders</span></a>
        <a href="./customer_product.html" class="nav-btn"><i class="fa-solid fa-shopping-bag nav-icon"></i><span>Products</span></a>
        <a href="./customer_profile.html" class="nav-btn"><i class="fa-solid fa-user nav-icon"></i><span>Profile</span></a>
    </nav>
    
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script>
    let carMap = {}, employeeMap = {}, branchMap = {}, planMap = {}, serviceMap = {}, paymentMap = {};
    let allOrders = [];
    let currentStatusFilter = "today";
    const customerId = 1;

    document.addEventListener("DOMContentLoaded", async function () {
        await Promise.all([
            fetchBranches(),
            fetchPlans(),
            fetchCarsForCustomer(),
            fetchEmployees(),
            fetchPayments(),
        ]);

        const branchIds = Object.keys(branchMap);
        if (branchIds.length > 0) {
            await Promise.all(branchIds.map(id => fetchServicesByBranch(id)));
        }

        fetch(`../Backend/get_customer_orders.php?customer_id=${customerId}`)
            .then(res => res.json())
            .then(data => {
                if (data.status === "success" && Array.isArray(data.orders)) {
                    allOrders = data.orders;
                    filterOrders();
                } else {
                    document.getElementById("orders-list").innerHTML = `<p style="text-align:center; color:#c33;">Failed to load your orders.</p>`;
                }
            });
        
        document.querySelectorAll(".category-tab").forEach(tab => {
            tab.addEventListener("click", () => {
                document.querySelector(".category-tab.active").classList.remove("active");
                tab.classList.add("active");
                currentStatusFilter = tab.dataset.status;
                filterOrders();
            });
        });
        document.getElementById("searchInput").addEventListener("input", filterOrders);
    });

    // --- NEW ROBUST FETCH FUNCTION ---
    // This version is smarter and automatically finds the data array in the JSON response.
    async function fetchData(url, map, idKey) {
        try {
            const res = await fetch(url);
            const data = await res.json();

            if (data.status === 'success') {
                // Intelligently find the key that holds the array of data (e.g., "employees", "cars")
                const dataKey = Object.keys(data).find(key => Array.isArray(data[key]));
                
                if (dataKey && data[dataKey].length > 0) {
                    data[dataKey].forEach(item => {
                        // Use the provided idKey to build the map
                        if (item[idKey]) {
                            map[item[idKey]] = item;
                        }
                    });
                }
            }
        } catch (error) { console.error(`Error fetching from ${url}:`, error); }
    }
    
    // These functions now use the new, more reliable fetchData
    async function fetchBranches() { await fetchData('../Backend/get_branch.php', branchMap, 'branch_id'); }
    async function fetchPlans() { await fetchData('../Backend/get_all_service_plans.php', planMap, 'plan_id'); }
    async function fetchCarsForCustomer() { await fetchData(`../Backend/get_car.php?customer_id=${customerId}`, carMap, 'car_id'); }
    async function fetchEmployees() { await fetchData('../Backend/get_employees.php', employeeMap, 'employee_id'); }
    async function fetchPayments() { await fetchData('../Backend/get_all_payments.php', paymentMap, 'payment_id'); }

    async function fetchServicesByBranch(branchId) {
        try {
            const res = await fetch(`../Backend/get_service_and_branch.php?branch_id=${branchId}`);
            const data = await res.json();
            if (data.status === "success" && Array.isArray(data.services)) {
                data.services.forEach(s => serviceMap[s.service_id] = s);
            }
        } catch (error) { console.error("Error fetching services:", error); }
    }

    function filterOrders() {
        const searchValue = document.getElementById("searchInput").value.toLowerCase();
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        let filtered = allOrders.filter(order => {
            const status = (order.order_status || "").toLowerCase();
            const orderDate = new Date(order.order_time);
            orderDate.setHours(0, 0, 0, 0);

            let matchStatus = false;
            switch (currentStatusFilter) {
                case "today": matchStatus = (orderDate.getTime() === today.getTime()) && (status === "pending" || status === "accepted"); break;
                case "upcoming": matchStatus = (orderDate > today) && (status === "pending" || status === "accepted"); break;
                case "history": matchStatus = (orderDate < today) || status === "completed"; break;
                case "rejected": matchStatus = (status === "cancelled" || status === "rejected"); break;
            }

            const car = carMap[order.car_id] || {};
            const plan = planMap[order.plan_id] || {};
            const service = serviceMap[plan.service_id] || {};
            const matchSearch = !searchValue ||
                (car.car_name || "").toLowerCase().includes(searchValue) ||
                (service.name || "").toLowerCase().includes(searchValue);
            return matchStatus && matchSearch;
        });

        filtered.sort((a, b) => new Date(b.order_time) - new Date(a.order_time));
        renderOrders(filtered);
    }
    
    function formatDate(dateStr) {
        if (!dateStr) return 'N/A';
        return new Date(dateStr).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
    }

    function renderOrders(list) {
        const container = document.getElementById('orders-list');
        if (list.length === 0) {
            container.innerHTML = '<p style="text-align:center;">No orders found.</p>';
            return;
        }
        
        let html = '';
        for (const order of list) {
            const car = carMap[order.car_id] || {};
            const emp = employeeMap[order.employee_id] || {};
            const payment = paymentMap[order.payment_id] || {};
            const plan = planMap[order.plan_id] || {};
            const service = serviceMap[plan.service_id] || {};
            const status = order.order_status.toLowerCase();
            const isCancellable = status === 'pending' || status === 'accepted';
            
            html += `
              <div class="order-card">
                  <div class="order-header">
                      <h3 class="order-title">${service.name || 'Service'}</h3>
                      <div class="order-status-badge order-status-${status}">${order.order_status}</div>
                  </div>
                  <div class="order-card-content">
                      <div class="order-card-image">
                          <img src="../Backend/${car.car_image || ''}" alt="${car.car_name}" onerror="this.onerror=null; this.src='placeholder.jpg';">
                      </div>
                      <div class="order-card-details">
                            <div class="info-row">
                                <i class="fa-solid fa-calendar-days"></i>
                                <span>${formatDate(order.order_time)}</span>
                            </div>
                            <div class="info-row">
                                <i class="fa-solid fa-car"></i>
                                <span>${car.car_name || 'N/A'} (${car.car_number || 'N/A'})</span>
                            </div>
                            <div class="info-row">
                                <i class="fa-solid fa-user-tie"></i>
                                <span>${emp.employee_name || 'Not Assigned'}</span>
                            </div>
                            <div class="order-summary">
                                <div class="total-row">
                                    <label>Total Amount</label>
                                    <span>â‚¹${parseFloat(order.total_amount || 0).toFixed(2)}</span>
                                </div>
                                <div class="payment-status">
                                    <label>Payment:</label>
                                    <span>${payment.payment_status || 'Unpaid'}</span>
                                </div>
                            </div>
                            ${isCancellable ? `
                            <div class="order-actions">
                                <button class="btn btn-cancel" onclick="cancelOrder(${order.order_id})">
                                    <i class="fa-solid fa-times"></i> Cancel Order
                                </button>
                            </div>` : ''}
                      </div>
                  </div>
              </div>`;
        }
        container.innerHTML = html;
    }

    async function cancelOrder(orderId) {
        if (!confirm("Are you sure you want to cancel this order? This action cannot be undone.")) {
            return;
        }
        const formData = new FormData();
        formData.append("order_id", orderId);
        try {
            const response = await fetch("../Backend/delete_order.php", { method: "POST", body: formData });
            const data = await response.json();
            if (data.status === "success") {
                toastr.success("Order cancelled successfully", "Success");
                allOrders = allOrders.filter(o => o.order_id != orderId);
                filterOrders();
            } else {
                toastr.error("Failed to cancel: " + (data.message || "Unknown error"), "Error");
            }
        } catch (e) {
            toastr.error("A network error occurred. Please try again.", "Error");
        }
    }
</script>

</body>
</html>