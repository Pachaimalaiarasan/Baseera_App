<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Products Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { background: #fff; margin: 0; font-family: 'Segoe UI', sans-serif; }
    .header { display: flex; align-items: center; padding: 18px 20px 0 14px; }
    .avatar { width: 48px; height: 48px; border-radius: 50%; margin-right: 10px; background: #eee; display: flex; align-items: center; justify-content: center; font-size: 28px; color: #333;}
    .header .text-box { margin-right: auto; }
    .header .welcome { color: #999; font-size: 18px; margin-bottom: -6px;}
    .header .admin { font-weight: bold; font-size: 26px; }
    .logout-btn { color: #e53935; font-weight: bold; font-size: 18px; border: none; background: none; cursor: pointer; }
    .title { text-align: center; font-weight: bold; font-size: 32px; margin: 12px 0 6px; }
    .branch-row { width: 94%; margin: 0 auto 10px; }
    .branch-select { width: 100%; font-size: 17px; padding: 11px 16px; border: none; border-bottom: 2px solid #ddd; background: #fff; border-radius: 6px 6px 0 0;}
    .search-box { width: 94%; margin: 10px auto 0; display: flex; align-items: center; background: #f2f2f2; border-radius: 20px; padding: 10px 15px; }
    .search-box input { border: none; outline: none; background: transparent; font-size: 19px; width: 100%; }
    .search-icon { font-size: 22px; color: #999; margin-right: 7px; }
    .products-wrap { padding: 24px 8px 120px; display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
    .prod-card { background: #fff; box-shadow: 0 2px 11px 1px #ccc6; border-radius: 22px; width: 180px; min-height: 180px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; margin-bottom: 8px;}
    .prod-card .stock-alert { position: absolute; bottom: 16px; left: 18px; color: #e53935; font-weight: 500; font-size: 15px;}
    .prod-card .rating { position: absolute; top: 10px; right: 10px; background: #fff; border-radius: 999px; box-shadow: 0 2px 6px #bbb8; padding: 2px 10px; font-size: 15px; font-weight: 500; display: flex; align-items: center;}
    .prod-card .rating span { color: #ffd600; margin-right: 2px;}
    .prod-card .prod-name { margin-top: 28px; font-size: 20px; font-weight: 500; }
    .prod-card .prod-price { font-size: 19px; font-weight: bold; margin: 3px 0 16px 0;}
    .add-btn {width: 92%; margin: 5px 4%; position: fixed; bottom: 80px; left: 0; right: 0; z-index: 9;}
    .add-btn button { width: 100%; padding: 20px 0; background: #2196f3; color: #fff; border-radius: 25px; border: none; font-weight: bold; font-size: 22px; box-shadow: 0 2px 7px #2196f34c; cursor: pointer;}
    .modal-bg { position: fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,.23); display:flex; align-items:center; justify-content:center; z-index: 90;}
    .modal { background: #fff8ff; border-radius: 24px; padding: 22px 14px 30px; box-shadow: 0 8px 32px #0003; width: 94vw; max-width: 420px; position: relative;}
    .modal-close {position: absolute; right:20px; top:10px; font-size: 28px; color: #e53935; cursor:pointer;}
    .img-upload-box { height:130px; background: #f5f5f7; border: 2px dashed #ddd; border-radius: 18px; margin-bottom: 18px; display: flex; flex-direction:column; align-items: center; justify-content: center; }
    .img-upload-label { font-size: 38px; color: #aaa; cursor:pointer;}
    .modal input, .modal textarea { width: 100%; margin-bottom: 10px; font-size: 18px; padding: 12px 16px; border-radius: 11px; border: 1.5px solid #eee; background: #f8f7fc;}
    .modal-row { display:flex; gap: 10px;}
    .modal input[type="file"] { display: none;}
    .modal-btn {width:100%; margin-top: 10px; background: #2196f3; color: #fff; border: none; border-radius: 10px; padding: 18px 0; font-size: 21px; font-weight: bold; cursor:pointer;}
    .bottom-nav { position: fixed; bottom: 0; left: 0; width:100vw; height: 70px; background: #171717; border-radius: 22px 22px 0 0; display: flex; justify-content: space-around; align-items: center; z-index: 98;}
    .bottom-nav .nav-btn { display: flex; flex-direction: column; align-items: center; color: #cfcfd8; font-size: 15px;}
    .bottom-nav .nav-btn.active { color: #2296f3; }
    .bottom-nav .nav-btn .nav-img { font-size: 26px;}
    .error-msg { color: #e53935; font-size: 17px; text-align: center; margin-bottom: 10px;}
  </style>
</head>
<body>
  <div class="header">
    <div class="avatar">üë®‚Äçüíº</div>
    <div class="text-box">
      <div class="welcome">Welcome</div>
      <div class="admin">Admin</div>
    </div>
    <button class="logout-btn" onclick="alert('Logout!');">Logout</button>
  </div>
  <div class="title">Products</div>
  <div class="branch-row">
    <select class="branch-select" id="branchSelect"></select>
  </div>
  <div class="search-box">
    <span class="search-icon">üîç</span>
    <input placeholder="Search for products" id="searchInput">
  </div>
  <div class="products-wrap" id="productsWrap"></div>
  <div class="add-btn" id="addBtn" style="display:none;">
    <button type="button" onclick="openAddProductModal()">Add Product</button>
  </div>
  <!-- Modal for add product -->
  <div class="modal-bg" id="modalBg" style="display:none;">
    <form class="modal" id="addProductForm" enctype="multipart/form-data" autocomplete="off">
      <span class="modal-close" onclick="closeModal()">&times;</span>
      <div class="img-upload-box">
        <label class="img-upload-label" for="product_image">
          <span id="previewImage">üì∑</span>
          <input type="file" id="product_image" name="product_image" accept="image/png, image/jpeg">
        </label>
      </div>
      <input type="text" name="product_name" placeholder="Product Name" required>
      <div class="modal-row">
        <input style="flex:1" type="number" step="0.01" name="product_buy_price" placeholder="Buy Price ($)" required>
        <input style="flex:1" type="number" step="0.01" name="product_sell_price" placeholder="Sell Price ($)" required>
      </div>
      <input type="number" name="product_quantity" placeholder="Stock Quantity" required>
      <input type="number" name="product_percentage_discount" min="0" max="100" placeholder="Discount Percentage (%)">
      <textarea name="product_desc" placeholder="Product Description"></textarea>
      <button class="modal-btn" type="submit">Add Product</button>
      <div class="error-msg" id="errorMsg"></div>
    </form>
  </div>
  <div class="bottom-nav">
    <div class="nav-btn"><span class="nav-img">‚åÇ</span>Home</div>
    <div class="nav-btn"><span class="nav-img">üõí</span>Orders</div>
    <div class="nav-btn active"><span class="nav-img">‚¨ú</span>Products</div>
    <div class="nav-btn"><span class="nav-img">üë§</span>Employees</div>
  </div>
<script>
const API_BASE = "http://localhost/Baseera_App/Backend/";
const ENDPOINTS = {
  getBranches:        API_BASE + "get_branch.php",
  getProducts:        API_BASE + "get_products.php",
  getProductMappings: API_BASE + "get_product_and_branch.php",
  addProduct:         API_BASE + "add_product.php",
  addProductBranch:   API_BASE + "add_product_and_branch.php"
};

let allBranches = [{branch_id:'all',branch_name:'All Branches'}];
let allMappings = [];
let allProducts = [];

document.addEventListener("DOMContentLoaded", () => {
  loadBranches();
  loadProducts();
  loadProductMappings();
  document.getElementById("searchInput").addEventListener("input", renderProducts);
  document.getElementById("branchSelect").addEventListener("change", onBranchChange);
  document.getElementById("product_image").addEventListener("change", onImageChange);
  document.getElementById("addProductForm").addEventListener("submit", handleAddProduct);
});

function loadBranches() {
  fetch(ENDPOINTS.getBranches)
    .then(res => res.json())
    .then(data => {
      let select = document.getElementById("branchSelect");
      select.innerHTML = "";
      let optionAll = document.createElement("option");
      optionAll.value = 'all';
      optionAll.innerText = "All Branches";
      select.appendChild(optionAll);
      for (let b of data.branches) {
        let opt = document.createElement("option");
        opt.value = b.branch_id;
        opt.innerText = b.branch_name;
        select.appendChild(opt);
      }
    });
}
function loadProducts() {
  fetch(ENDPOINTS.getProducts)
    .then(r=>r.json())
    .then(res=>{
      if(res.status==='success') {
        allProducts = res.products;
        renderProducts();
      }
    });
}
function loadProductMappings() {
  fetch(ENDPOINTS.getProductMappings)
    .then(r=>r.json())
    .then(res=>{
      if(res.status==='success'){
        allMappings = res.mappings;
      }
    });
}
function onBranchChange() {
  let v = document.getElementById("branchSelect").value;
  document.getElementById("addBtn").style.display = (v !== 'all') ? 'block':'none';
  renderProducts();
}
function renderProducts() {
  let wrap = document.getElementById("productsWrap");
  let q = document.getElementById("searchInput").value.toLowerCase();
  let branchId = document.getElementById("branchSelect").value;
  let showProds;
  if(branchId==='all') {
    showProds = allProducts;
  } else {
    let prodIds = allMappings.filter(m=>m.branch_id==branchId).map(m=>Number(m.product_id));
    showProds = allProducts.filter(p=>prodIds.includes(Number(p.product_id)));
  }
  if(q) showProds = showProds.filter(p=>p.product_name.toLowerCase().includes(q));
  wrap.innerHTML = '';
  if(showProds.length===0) {
    wrap.innerHTML = "<div style='font-size:18px;color:#aaa;text-align:center;margin-top:40px;'>No products found</div>";
    return;
  }
  for(let prod of showProds) {
    let div = document.createElement("div");
    div.className = "prod-card";
    div.innerHTML =
      `<div class="rating"><span>‚òÖ</span> 4.5</div>
      <div class="prod-name">${prod.product_name}</div>
      <div class="prod-price">‚Çπ${prod.product_sell_price.toFixed(2)}</div>` +
      ((prod.product_quantity<=2)? `<div class="stock-alert">Only ${prod.product_quantity} left in stock!</div>` : "");
    wrap.appendChild(div);
  }
}
function openAddProductModal() {
  document.getElementById("modalBg").style.display = "flex";
  document.getElementById("addProductForm").reset();
  document.getElementById("errorMsg").innerText = "";
  document.getElementById("previewImage").innerHTML = "üì∑";
}
function closeModal() {
  document.getElementById("modalBg").style.display = "none";
}
function onImageChange(e) {
  const file = e.target.files[0];
  const imgPreview = document.getElementById("previewImage");
  if(file) {
    let reader = new FileReader();
    reader.onload = function(ev) {
      imgPreview.innerHTML = `<img src="${ev.target.result}" style="max-width:100px;max-height:100px;border-radius:13px;">`;
    };
    reader.readAsDataURL(file);
  } else {
    imgPreview.innerHTML = "üì∑";
  }
}
function handleAddProduct(e) {
  e.preventDefault();
  let form = document.getElementById("addProductForm");
  let formData = new FormData(form);
  fetch(ENDPOINTS.addProduct, {
    method: "POST",
    body: formData
  }).then(r=>r.json())
    .then(data=>{
      if(data.status==="success") {
        let branchId = document.getElementById("branchSelect").value;
        fetch(ENDPOINTS.addProductBranch, {
          method: "POST",
          headers: {'Content-Type':'application/x-www-form-urlencoded'},
          body: `branch_id=${encodeURIComponent(branchId)}&product_id=${encodeURIComponent(data.product.product_id)}`
        }).then(res=>res.json()).then(r=>{
          if(r.status==="success") {
            closeModal();
            loadProducts();
            loadProductMappings();
          }
        });
      } else {
        document.getElementById("errorMsg").innerText = data.message || "Failed to add product";
      }
    }).catch(()=> {
      document.getElementById("errorMsg").innerText = "Failed to add product. Try again!";
    });
}
</script>
</body>
</html>
